<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ .PageTitle }}</title>
  <meta name="description" content="{{ .Description }}">
  <meta property="og:title" content="{{ .PageTitle }}">
  <meta property="og:description" content="{{ .Description }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://hfresh.info/og/generic?title=Recettes">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ .PageTitle }}">
  <meta name="twitter:description" content="{{ .Description }}">
  <link rel="preload" as="style" href="/static/list.css">
  <link rel="stylesheet" href="/static/list.css">
  <style>
    body { background: #f8fafc; }
    .pill { background: #eef2ff; color: #312e81; }
    .pill-dark { background: #0f172a; color: #e2e8f0; }
  </style>
  <script>
    (() => {
      const debounce = (fn, delay = 300) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      };

      function resetPage(form) {
        const page = form.querySelector('input[name="page"]');
        if (page) page.value = "1";
      }

      function setupFilters() {
        const form = document.getElementById("filters-form");
        if (!form) return;
        const search = form.querySelector('input[name="q"]');
        const selects = form.querySelectorAll("select");
        const reset = document.getElementById("filters-reset");

        selects.forEach((select) => {
          select.addEventListener("change", () => {
            resetPage(form);
            form.requestSubmit();
          });
        });

        if (search) {
          search.addEventListener(
            "input",
            debounce(() => {
              resetPage(form);
              form.requestSubmit();
            }, 300)
          );
        }

        if (reset) {
          reset.addEventListener("click", (e) => {
            e.preventDefault();
            form.reset();
            resetPage(form);
            window.location.href = "/recettes";
          });
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupFilters);
      } else {
        setupFilters();
      }
    })();
  </script>
</head>
<body class="min-h-screen text-zinc-900">
  <main class="max-w-7xl mx-auto px-6 py-10 space-y-8">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div>
        <p class="text-xs uppercase tracking-wider text-zinc-500">HelloFresh Database</p>
        <h1 class="text-3xl font-semibold text-zinc-800">Recettes</h1>
      </div>
      <p class="text-sm text-zinc-500">
        {{ .FilteredCount }} résultat{{ if ne .FilteredCount 1 }}s{{ end }} sur {{ .TotalRecipes }}
      </p>
    </header>

    <section class="bg-white border border-zinc-200 shadow-sm rounded-xl p-5 space-y-4">
      <form id="filters-form" method="get" class="space-y-4">
        <input type="hidden" name="page" value="{{ .Page }}">
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          <label class="space-y-1 block">
            <span class="text-sm font-medium text-zinc-700">Recherche</span>
            <input
              type="search"
              name="q"
              value="{{ .Query }}"
              placeholder="Rechercher une recette..."
              class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
          </label>

          <label class="space-y-1 block">
            <span class="text-sm font-medium text-zinc-700">Tag / régime</span>
            <select
              name="diet"
              class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
              <option value="">Tous</option>
              {{ range .AvailableDiets }}
                <option value="{{ . }}" {{ if eq $.Diet . }}selected{{ end }}>{{ . }}</option>
              {{ end }}
            </select>
          </label>

          <label class="space-y-1 block">
            <span class="text-sm font-medium text-zinc-700">Tag précis</span>
            <select
              name="tag"
              class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
              <option value="">Tous</option>
              {{ range .AvailableTags }}
                <option value="{{ . }}" {{ if eq $.Tag . }}selected{{ end }}>{{ . }}</option>
              {{ end }}
            </select>
          </label>

          <label class="space-y-1 block">
            <span class="text-sm font-medium text-zinc-700">Difficulté</span>
            <select
              name="difficulty"
              class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
              <option value="">Toutes</option>
              {{ range .AvailableDifficulties }}
                <option value="{{ . }}" {{ if eq $.Difficulty . }}selected{{ end }}>{{ . }}</option>
              {{ end }}
            </select>
          </label>

          <label class="space-y-1 block">
            <span class="text-sm font-medium text-zinc-700">Tri</span>
            <select
              name="sort"
              class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
              <option value="title-asc" {{ if eq .Sort "title-asc" }}selected{{ end }}>Nom (A → Z)</option>
              <option value="title-desc" {{ if eq .Sort "title-desc" }}selected{{ end }}>Nom (Z → A)</option>
              <option value="prep-asc" {{ if eq .Sort "prep-asc" }}selected{{ end }}>Temps (plus court)</option>
              <option value="prep-desc" {{ if eq .Sort "prep-desc" }}selected{{ end }}>Temps (plus long)</option>
              <option value="difficulty-asc" {{ if eq .Sort "difficulty-asc" }}selected{{ end }}>Difficulté (facile → difficile)</option>
              <option value="difficulty-desc" {{ if eq .Sort "difficulty-desc" }}selected{{ end }}>Difficulté (difficile → facile)</option>
            </select>
          </label>
        </div>

        <div class="flex flex-wrap gap-3">
          <button
            type="submit"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
          >
            Mettre à jour
          </button>
          <button
            type="button"
            id="filters-reset"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-zinc-300 text-sm font-medium text-zinc-700 hover:bg-zinc-50"
          >
            Réinitialiser
          </button>
        </div>
      </form>
    </section>

    {{ if eq .FilteredCount 0 }}
      <div class="bg-white border border-zinc-200 rounded-xl p-6 text-center text-zinc-600 shadow-sm">
        Aucune recette ne correspond à votre recherche. Ajustez vos filtres pour continuer.
      </div>
    {{ else }}
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {{ range .Recipes }}
          <article class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden flex flex-col">
            {{ if .Image }}
              <img src="{{ .Image }}" alt="{{ .Title }}" class="h-48 w-full object-cover">
            {{ end }}
            <div class="p-4 space-y-3 flex-1 flex flex-col">
              <h2 class="text-lg font-semibold text-zinc-800">
                <a href="{{ .URL }}" class="hover:underline">{{ .Title }}</a>
              </h2>
              {{ if .Description }}
                <p class="text-sm text-zinc-600 line-clamp-3">{{ .Description }}</p>
              {{ end }}
              <div class="text-xs text-zinc-500 flex flex-wrap gap-3">
                {{ if .Prep_time }}<span>Préparation : {{ .Prep_time }}</span>{{ end }}
                {{ if .Difficulty }}<span>Difficulté : {{ .Difficulty }}</span>{{ end }}
              </div>
              {{ if .Tags }}
                <div class="flex flex-wrap gap-2">
                  {{ range .Tags }}
                    <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">{{ . }}</span>
                  {{ end }}
                </div>
              {{ end }}
              <div class="flex gap-2 pt-2 mt-auto">
                <a href="{{ .URL }}" class="px-3 py-2 text-sm font-medium rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Détails</a>
                {{ if .HelloFreshURL }}
                  <a href="{{ .HelloFreshURL }}" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-medium rounded-lg border border-zinc-300 text-zinc-700 hover:bg-zinc-50">HelloFresh</a>
                {{ end }}
              </div>
            </div>
          </article>
        {{ end }}
      </div>
    {{ end }}

    {{ if gt .TotalPages 1 }}
      <nav class="flex items-center justify-between pt-4 border-t border-zinc-200">
        <a
          class="px-4 py-2 rounded-lg border border-zinc-300 text-sm font-medium text-zinc-700 hover:bg-zinc-50 {{ if not .PrevURL }}opacity-50 pointer-events-none{{ end }}"
          {{ if .PrevURL }}href="{{ .PrevURL }}"{{ end }}
        >Précédent</a>
        <span class="text-sm text-zinc-600">Page {{ .Page }} / {{ .TotalPages }}</span>
        <a
          class="px-4 py-2 rounded-lg border border-zinc-300 text-sm font-medium text-zinc-700 hover:bg-zinc-50 {{ if not .NextURL }}opacity-50 pointer-events-none{{ end }}"
          {{ if .NextURL }}href="{{ .NextURL }}"{{ end }}
        >Suivant</a>
      </nav>
    {{ end }}
  </main>
</body>
</html>
